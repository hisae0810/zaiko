<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ¨åº«åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ | æ—¥æœ¬å…‰é›»</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', 'Yu Gothic UI', Meiryo, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: slideDown 0.5s ease-out;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .header h1 { color: #333; font-size: 28px; margin-bottom: 15px; }
        .header-subtitle { color: #666; font-size: 14px; margin-top: 10px; }
        .year-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }
        .selector-label {
            font-weight: 600;
            color: #666;
            font-size: 15px;
        }
        .year-btn {
            padding: 10px 24px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .year-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateY(-2px);
        }
        .year-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        select:hover { border-color: #667eea; }
        .reset-btn {
            background: #f39c12;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .reset-btn:hover {
            background: #e67e22;
            transform: translateY(-2px);
        }
        .refresh-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }
        .refresh-btn:hover { transform: translateY(-2px); }
        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }
        .error {
            background: #fee2e2;
            color: #991b1b;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .info-panel {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border-left: 6px solid #f39c12;
            animation: slideDown 0.6s ease-out;
        }
        .info-panel h2 { color: #2d3436; font-size: 24px; margin-bottom: 20px; }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .info-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .info-box h3 {
            color: #2d3436;
            font-size: 18px;
            margin-bottom: 15px;
            border-bottom: 2px solid #f39c12;
            padding-bottom: 10px;
        }
        .info-box ul { list-style: none; padding: 0; }
        .info-box li {
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
            line-height: 1.8;
        }
        .info-box li:last-child { border-bottom: none; }
        .status-excellent { color: #27ae60; font-weight: bold; }
        .status-good { color: #f39c12; font-weight: bold; }
        .status-warning { color: #e67e22; font-weight: bold; }
        .status-danger { color: #e74c3c; font-weight: bold; }
        .formula {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 15px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
        }
        .highlight-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        .evaluation-panel {
            background: linear-gradient(135deg, #a8e6cf 0%, #56ab91 100%);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border-left: 6px solid #27ae60;
            animation: slideDown 0.7s ease-out;
        }
        .evaluation-panel h2 {
            color: #1e3a2e;
            font-size: 22px;
            margin-bottom: 15px;
        }
        .evaluation-note {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            line-height: 1.8;
        }
        .evaluation-note strong {
            color: #27ae60;
            font-size: 16px;
        }
        .evaluation-note ul {
            margin-top: 10px;
            margin-left: 20px;
            line-height: 1.8;
        }
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .kpi-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: fadeInUp 0.6s ease-out both;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .kpi-card:nth-child(1) { animation-delay: 0.1s; }
        .kpi-card:nth-child(2) { animation-delay: 0.2s; }
        .kpi-card:nth-child(3) { animation-delay: 0.3s; }
        .kpi-card:nth-child(4) { animation-delay: 0.4s; }
        .kpi-card:nth-child(5) { animation-delay: 0.5s; }
        .kpi-label { color: #666; font-size: 14px; margin-bottom: 10px; }
        .kpi-value { font-size: 36px; font-weight: bold; color: #333; margin-bottom: 5px; }
        .kpi-subtext { font-size: 13px; color: #999; }
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .chart-card h2 { color: #333; font-size: 18px; margin-bottom: 20px; }
        .table-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow-x: auto;
            margin-bottom: 20px;
        }
        table { width: 100%; border-collapse: collapse; }
        th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e0e0e0;
            font-size: 13px;
        }
        td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }
        tr:hover td { background: #f8f9fa; }
        .number { text-align: right; }
        .row-excellent { background: #d5f4e6 !important; }
        .row-good { background: #fff3cd !important; }
        .row-warning { background: #ffe5d0 !important; }
        .row-danger { background: #f8d7da !important; }
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }
        .badge-top { background: #ffd700; color: #333; }
        .badge-improved { background: #90EE90; color: #333; }
        .badge-stable { background: #87CEEB; color: #333; }
        .badge-warning { background: #FFB6C1; color: #333; }
        @media (max-width: 768px) {
            .chart-grid { grid-template-columns: 1fr; }
            .info-grid { grid-template-columns: 1fr; }
            .kpi-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š åœ¨åº«åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆç·åˆè©•ä¾¡ç‰ˆï¼‰</h1>
            <div class="header-subtitle">
                é€šå¸¸æœˆãƒ™ãƒ¼ã‚¹ã®åœ¨åº«å›è»¢ç‡ã§ã€çœŸã®åœ¨åº«ç®¡ç†èƒ½åŠ›ã‚’è©•ä¾¡ã—ã¾ã™
            </div>
            <div class="year-selector">
                <span class="selector-label">ğŸ“… è¡¨ç¤ºå¹´åº¦:</span>
                <button class="year-btn active" id="yearAll" onclick="selectYear('all')">å…¨å¹´åº¦</button>
                <button class="year-btn" id="year2024" onclick="selectYear('2024')">2024å¹´åº¦</button>
                <button class="year-btn" id="year2025" onclick="selectYear('2025')">2025å¹´åº¦</button>
            </div>
            <div class="controls">
                <select id="departmentFilter"><option value="all">å…¨éƒ¨é–€</option></select>
                <select id="officeFilter"><option value="all">å…¨å–¶æ¥­æ‰€</option></select>
                <button class="reset-btn" onclick="resetFilters()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
                <button class="refresh-btn" onclick="loadData()">â†» ãƒšãƒ¼ã‚¸æ›´æ–°</button>
            </div>
        </div>
        <div id="loading" class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
        <div id="error" style="display:none;"></div>
        <div id="content" style="display:none;">
            <div class="evaluation-panel">
                <h2>ğŸ¯ ç·åˆè©•ä¾¡ã«ã¤ã„ã¦</h2>
                <div class="evaluation-note">
                    <strong>ğŸ“Œ é€šå¸¸æœˆå¹³å‡å›è»¢ç‡ã‚’æ¡ç”¨ã™ã‚‹ç†ç”±ï¼š</strong>
                    <ul>
                        <li>âœ… <strong>æ£šå¸æœˆï¼ˆ3æœˆãƒ»10æœˆï¼‰ã‚’é™¤å¤–</strong>ï¼šæœˆæœ«åœ¨åº«ãŒæ„å›³çš„ã«å°‘ãªããªã‚‹ãŸã‚ã€å®ŸåŠ›ã‚’æ­£ã—ãåæ˜ ã—ãªã„</li>
                        <li>âœ… <strong>ç‰¹æ®Šæ¡ˆä»¶ï¼ˆ100å›è»¢è¶…ï¼‰ã®å½±éŸ¿ã‚’è»½æ¸›</strong>ï¼šç—…é™¢æ–°ç¯‰ãªã©ã®ä¸€æ™‚çš„ãªå¤§å‹æ¡ˆä»¶ã‚’è€ƒæ…®</li>
                        <li>âœ… <strong>å®‰å®šæ€§ã‚‚è©•ä¾¡</strong>ï¼šé€šå¸¸æ¥­å‹™ã§ã®ç¶™ç¶šçš„ãªåœ¨åº«ç®¡ç†èƒ½åŠ›ã‚’æ¸¬å®š</li>
                        <li>âœ… <strong>æ¯”è¼ƒå¯èƒ½æ€§ã®å‘ä¸Š</strong>ï¼šå–¶æ¥­æ‰€é–“ã®å…¬å¹³ãªè©•ä¾¡ãŒå¯èƒ½</li>
                    </ul>
                </div>
            </div>
            <div class="info-panel">
                <h2>ğŸ’¡ åœ¨åº«å›è»¢ç‡ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ã®é–¢ä¿‚</h2>
                <div class="formula">
                    åœ¨åº«å›è»¢ç‡ = å½“æœˆå‡ºåº«æ•° Ã· å¹³å‡åœ¨åº«æ•°ï¼ˆå‰æœˆæœ«åœ¨åº« + æœˆæœ«åœ¨åº«ï¼‰Ã· 2
                </div>
                <div class="highlight-box">
                    <strong>ğŸ’° ãªãœåœ¨åº«å›è»¢ç‡ãŒé‡è¦ãªã®ã‹ï¼Ÿ</strong><br>
                    åœ¨åº«ã¯ã€Œä»•å…¥å…ˆã«æ”¯æ‰•æ¸ˆã¿ã ãŒã€ã¾ã å£²ä¸Šã¨ã—ã¦å›åã§ãã¦ã„ãªã„ãŠé‡‘ã€ã§ã™ã€‚<br>
                    åœ¨åº«å›è»¢ç‡ãŒä½ã„ = è³‡é‡‘ãŒé•·æœŸé–“å›ºå®šã•ã‚Œã‚‹ = ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ãŒæ‚ªåŒ–ã—ã¾ã™ã€‚
                </div>
                <div class="info-grid">
                    <div class="info-box">
                        <h3>ğŸ¯ è©•ä¾¡åŸºæº–</h3>
                        <ul>
                            <li><span class="status-excellent">ğŸŸ¢ æœˆé–“30å›ä»¥ä¸Š</span> = æœ€å„ªç§€<br>
                            <small>ç´„1æ—¥ã§åœ¨åº«ãŒå…¥ã‚Œæ›¿ã‚ã‚‹ã€‚è³‡é‡‘åŠ¹ç‡ãŒæ¥µã‚ã¦è‰¯ã„ã€‚</small></li>
                            <li><span class="status-good">ğŸŸ¡ æœˆé–“20ã€œ30å›</span> = å„ªç§€<br>
                            <small>ç´„1ã€œ1.5æ—¥ã§åœ¨åº«ãŒå…¥ã‚Œæ›¿ã‚ã‚‹ã€‚é«˜æ°´æº–ã®åœ¨åº«ç®¡ç†ã€‚</small></li>
                            <li><span class="status-warning">ğŸŸ  æœˆé–“15ã€œ20å›</span> = æ¨™æº–<br>
                            <small>ç´„1.5ã€œ2æ—¥ã§åœ¨åº«ãŒå…¥ã‚Œæ›¿ã‚ã‚‹ã€‚æ¨™æº–çš„ãªç®¡ç†ãƒ¬ãƒ™ãƒ«ã€‚</small></li>
                            <li><span class="status-danger">ğŸ”´ æœˆé–“15å›æœªæº€</span> = è¦æ”¹å–„<br>
                            <small>2æ—¥ä»¥ä¸Šåœ¨åº«ã‚’ä¿æœ‰ã€‚æ”¹å–„ã®ä½™åœ°ã‚ã‚Šã€‚</small></li>
                        </ul>
                    </div>
                    <div class="info-box">
                        <h3>ğŸ’¸ è³‡é‡‘ç¹°ã‚Šã¸ã®å½±éŸ¿</h3>
                        <ul>
                            <li><strong>æœ¬ç¤¾ã¸ã®æ”¯æ‰•</strong><br>20æ—¥ç· ã‚ â†’ 4ãƒ¶æœˆå¾Œæ‰•ã„ï¼ˆ120æ—¥çŒ¶äºˆï¼‰</li>
                            <li><strong>ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã‹ã‚‰ã®å…¥é‡‘</strong><br>å„ªè‰¯ï¼š60æ—¥å¾Œã€åŒ»è–¬å“å¸ï¼š180æ—¥å¾Œ</li>
                            <li><strong>åœ¨åº«ä¿ç®¡ãŒé•·ã„</strong><br>â†’ è³‡é‡‘ãŒå›ºå®š â†’ ä»–ã®å–å¼•ã«ä½¿ãˆãªã„</li>
                        </ul>
                    </div>
                    <div class="info-box">
                        <h3>âœ… å®Ÿè·µãƒã‚¤ãƒ³ãƒˆ</h3>
                        <ul>
                            <li>ğŸ“¦ åœ¨åº«ã¯æœ€å°é™ã«</li>
                            <li>âš¡ ç´ æ—©ã„å‡ºè·ãƒ»ç´å“</li>
                            <li>ğŸ† å„ªè‰¯ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼å„ªå…ˆ</li>
                            <li>ğŸš¨ æ»ç•™åœ¨åº«ã«æ³¨æ„</li>
                        </ul>
                    </div>
                    <div class="info-box">
                        <h3>ğŸ“Œ å‚è€ƒãƒ‡ãƒ¼ã‚¿</h3>
                        <ul>
                            <li>è£½é€ æ¥­å¹³å‡ï¼š7.55å›/å¹´</li>
                            <li>å½“ç¤¾ç›®æ¨™ï¼šæœˆé–“20å›ä»¥ä¸Š</li>
                            <li>åœ¨åº«é‡‘é¡ã¯å®Ÿãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div id="dashboard">
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-label">ğŸ† é€šå¸¸æœˆå¹³å‡å›è»¢ç‡</div>
                        <div class="kpi-value" id="kpiNormalTurnover">-</div>
                        <div class="kpi-subtext" id="kpiNormalDays">ç´„-æ—¥ã§ç¾é‡‘åŒ–</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">ğŸ“Š å…¨ä½“å¹³å‡å›è»¢ç‡</div>
                        <div class="kpi-value" id="kpiAllTurnover">-</div>
                        <div class="kpi-subtext" id="kpiAllDays">ç´„-æ—¥ã§ç¾é‡‘åŒ–</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">ğŸ“¦ å¹³å‡æœˆæœ«åœ¨åº«æ•°</div>
                        <div class="kpi-value" id="kpiInventory">-</div>
                        <div class="kpi-subtext" id="kpiInventoryAmount">æ¨å®šé‡‘é¡: -</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">ğŸ“ˆ å¹³å‡å½“æœˆå‡ºåº«æ•°</div>
                        <div class="kpi-value" id="kpiShipment">-</div>
                        <div class="kpi-subtext" id="kpiShipmentAmount">æ¨å®šé‡‘é¡: -</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">ğŸ¢ å–¶æ¥­æ‰€æ•°</div>
                        <div class="kpi-value" id="kpiOffices">-</div>
                        <div class="kpi-subtext">é›†è¨ˆå¯¾è±¡</div>
                    </div>
                </div>
                <div class="chart-grid">
                    <div class="chart-card">
                        <h2>ğŸ“Š åœ¨åº«æ¨ç§»</h2>
                        <canvas id="inventoryChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h2>ğŸ”„ åœ¨åº«å›è»¢ç‡ãƒˆãƒ¬ãƒ³ãƒ‰</h2>
                        <canvas id="turnoverChart"></canvas>
                    </div>
                </div>
                <div class="table-card">
                    <h2>ğŸ¢ å–¶æ¥­æ‰€åˆ¥ç·åˆè©•ä¾¡ï¼ˆé€šå¸¸æœˆå¹³å‡ãƒ™ãƒ¼ã‚¹ï¼‰</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>é †ä½</th>
                                <th>å–¶æ¥­æ‰€</th>
                                <th>éƒ¨é–€</th>
                                <th class="number">é€šå¸¸æœˆå¹³å‡<br>å›è»¢ç‡</th>
                                <th class="number">å…¨æœŸé–“å¹³å‡<br>å›è»¢ç‡</th>
                                <th class="number">æ¨™æº–åå·®</th>
                                <th class="number">ç¾é‡‘åŒ–æ—¥æ•°</th>
                                <th>ç·åˆè©•ä¾¡</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script>
        let allData = [];
        let charts = {};
        let selectedYear = 'all';

        // CSVèª­ã¿è¾¼ã¿
        async function loadData() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error').style.display = 'none';
                document.getElementById('content').style.display = 'none';
                const response = await fetch('data.csv');
                if (!response.ok) throw new Error('data.csvãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                const text = await response.text();
                allData = parseCSV(text);
                if (allData.length === 0) throw new Error('ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™');
                initializeFilters();
                updateDashboard();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').innerHTML =
                    `<strong>ã‚¨ãƒ©ãƒ¼:</strong> ${error.message}<br>` +
                    `data.csv ãƒ•ã‚¡ã‚¤ãƒ«ãŒåŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
            }
        }

        // CSVè§£æ
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            return lines.slice(1).map(line => {
                const values = line.split(',');
                const yyyymm = values[0]?.trim();
                const year = parseInt(yyyymm.substring(0, 4));
                const month = parseInt(yyyymm.substring(4, 6));
                return {
                    æœˆYYYYMM: yyyymm,
                    å¹´: year,
                    æœˆæ•°å€¤: month,
                    æœˆ: `${month}æœˆ`,
                    å¹´æœˆ: `${year}å¹´${month}æœˆ`,
                    å–¶æ¥­æ‰€: values[1]?.trim(),
                    éƒ¨é–€: values[2]?.trim(),
                    å‰æœˆæœ«åœ¨åº«: parseInt(values[3]) || 0,
                    å‰æœˆæœ«åœ¨åº«é«˜: parseInt(values[4]) || 0,
                    å½“æœˆå…¥åº«: parseInt(values[5]) || 0,
                    å½“æœˆå…¥åº«é«˜: parseInt(values[6]) || 0,
                    å½“æœˆå‡ºåº«: parseInt(values[7]) || 0,
                    å½“æœˆå‡ºåº«é«˜: parseInt(values[8]) || 0,
                    æœˆæœ«åœ¨åº«: parseInt(values[9]) || 0,
                    æœˆæœ«åœ¨åº«é«˜: parseInt(values[10]) || 0,
                    åœ¨åº«å›è»¢ç‡: parseFloat(values[11]) || 0
                };
            });
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function formatMoney(amount) {
            return 'Â¥' + Math.round(amount).toLocaleString();
        }

        function calculateCashDays(turnoverRate) {
            return 30 / turnoverRate;
        }

        // å–¶æ¥­æ‰€ã®ä¸¦ã³é †
        function sortOffices(offices) {
            return offices.sort((a, b) => {
                const isAY_a = a.startsWith('AY');
                const isAY_b = b.startsWith('AY');
                if (isAY_a && !isAY_b) return -1;
                if (!isAY_a && isAY_b) return 1;
                const isAJ_a = a.startsWith('AJ');
                const isAJ_b = b.startsWith('AJ');
                if (isAJ_a && !isAJ_b) return -1;
                if (!isAJ_a && isAJ_b) return 1;
                return a.localeCompare(b);
            });
        }

        // æœˆã‚’4æœˆå§‹ã¾ã‚Šã§ã‚½ãƒ¼ãƒˆ
        function sortMonthsFiscalYear(dataArray) {
            return dataArray.sort((a, b) => {
                const fiscalYearA = a.æœˆæ•°å€¤ >= 4 ? a.å¹´ : a.å¹´ - 1;
                const fiscalYearB = b.æœˆæ•°å€¤ >= 4 ? b.å¹´ : b.å¹´ - 1;
                if (fiscalYearA !== fiscalYearB) {
                    return fiscalYearA - fiscalYearB;
                }
                const fiscalMonthA = a.æœˆæ•°å€¤ >= 4 ? a.æœˆæ•°å€¤ - 4 : a.æœˆæ•°å€¤ + 8;
                const fiscalMonthB = b.æœˆæ•°å€¤ >= 4 ? b.æœˆæ•°å€¤ - 4 : b.æœˆæ•°å€¤ + 8;
                return fiscalMonthA - fiscalMonthB;
            });
        }

        // é€šå¸¸æœˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆæ£šå¸æœˆã¨æ¥µç«¯ãªå€¤ã‚’é™¤å¤–ï¼‰
        function filterNormalMonths(dataArray) {
            return dataArray.filter(d => {
                // 3æœˆã€10æœˆã‚’é™¤å¤–ï¼ˆæ£šå¸æœˆï¼‰
                if (d.æœˆæ•°å€¤ === 3 || d.æœˆæ•°å€¤ === 10) return false;
                // æ¥µç«¯ã«é«˜ã„å›è»¢ç‡ï¼ˆ100è¶…ï¼‰ã‚’é™¤å¤–ï¼ˆç‰¹æ®Šæ¡ˆä»¶ã¨åˆ¤æ–­ï¼‰
                if (d.åœ¨åº«å›è»¢ç‡ > 100) return false;
                return true;
            });
        }
        // å¹´åº¦é¸æŠ
        function selectYear(year) {
            selectedYear = year;
            document.querySelectorAll('.year-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('year' + (year === 'all' ? 'All' : year)).classList.add('active');
            updateDashboard();
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ
        function resetFilters() {
            selectYear('all');
            document.getElementById('departmentFilter').value = 'all';
            document.getElementById('officeFilter').value = 'all';
            updateDashboard();
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼åˆæœŸåŒ–
        function initializeFilters() {
            const offices = [...new Set(allData.map(d => d.å–¶æ¥­æ‰€))];
            const departments = [...new Set(allData.map(d => d.éƒ¨é–€))].sort();
            const sortedOffices = sortOffices(offices);
            document.getElementById('officeFilter').innerHTML = '<option value="all">å…¨å–¶æ¥­æ‰€</option>' +
                sortedOffices.map(o => `<option value="${o}">${o}</option>`).join('');
            document.getElementById('departmentFilter').innerHTML = '<option value="all">å…¨éƒ¨é–€</option>' +
                departments.map(d => `<option value="${d}">${d}</option>`).join('');
            document.getElementById('officeFilter').onchange = updateDashboard;
            document.getElementById('departmentFilter').onchange = updateDashboard;
        }

        // ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        function getFilteredData() {
            const dept = document.getElementById('departmentFilter').value;
            const office = document.getElementById('officeFilter').value;
            return allData.filter(d => {
                if (selectedYear !== 'all') {
                    const fiscalYear = d.æœˆæ•°å€¤ >= 4 ? d.å¹´ : d.å¹´ - 1;
                    if (fiscalYear !== parseInt(selectedYear)) return false;
                }
                if (dept !== 'all' && d.éƒ¨é–€ !== dept) return false;
                if (office !== 'all' && d.å–¶æ¥­æ‰€ !== office) return false;
                return true;
            });
        }

        // KPIæ›´æ–°
        function updateKPIs(data) {
            const normalData = filterNormalMonths(data);
            
            // é€šå¸¸æœˆå¹³å‡å›è»¢ç‡
            const normalAvgTurnover = normalData.reduce((sum, d) => sum + d.åœ¨åº«å›è»¢ç‡, 0) / normalData.length;
            const normalDays = calculateCashDays(normalAvgTurnover);
            
            // å…¨æœŸé–“å¹³å‡å›è»¢ç‡
            const allAvgTurnover = data.reduce((sum, d) => sum + d.åœ¨åº«å›è»¢ç‡, 0) / data.length;
            const allDays = calculateCashDays(allAvgTurnover);
            
            // å¹³å‡åœ¨åº«ãƒ»å‡ºåº«
            const avgInventory = data.reduce((sum, d) => sum + d.æœˆæœ«åœ¨åº«, 0) / data.length;
            const avgInventoryAmount = data.reduce((sum, d) => sum + d.æœˆæœ«åœ¨åº«é«˜, 0) / data.length;
            const avgShipment = data.reduce((sum, d) => sum + d.å½“æœˆå‡ºåº«, 0) / data.length;
            const avgShipmentAmount = data.reduce((sum, d) => sum + d.å½“æœˆå‡ºåº«é«˜, 0) / data.length;
            const offices = new Set(data.map(d => d.å–¶æ¥­æ‰€)).size;

            document.getElementById('kpiNormalTurnover').textContent = normalAvgTurnover.toFixed(1);
            document.getElementById('kpiNormalDays').textContent = `ç´„${normalDays.toFixed(1)}æ—¥ã§ç¾é‡‘åŒ–`;
            
            document.getElementById('kpiAllTurnover').textContent = allAvgTurnover.toFixed(1);
            document.getElementById('kpiAllDays').textContent = `ç´„${allDays.toFixed(1)}æ—¥ã§ç¾é‡‘åŒ–`;
            
            document.getElementById('kpiInventory').textContent = Math.round(avgInventory).toLocaleString();
            document.getElementById('kpiInventoryAmount').textContent = 'æ¨å®šé‡‘é¡: ' + formatMoney(avgInventoryAmount);
            
            document.getElementById('kpiShipment').textContent = Math.round(avgShipment).toLocaleString();
            document.getElementById('kpiShipmentAmount').textContent = 'æ¨å®šé‡‘é¡: ' + formatMoney(avgShipmentAmount);
            
            document.getElementById('kpiOffices').textContent = offices;
        }

        // ã‚°ãƒ©ãƒ•æ›´æ–°
        function updateCharts(data) {
            const monthlyData = {};
            data.forEach(d => {
                const key = d.æœˆYYYYMM;
                if (!monthlyData[key]) {
                    monthlyData[key] = {
                        åœ¨åº«: 0,
                        å‡ºåº«: 0,
                        å›è»¢ç‡: [],
                        é€šå¸¸æœˆå›è»¢ç‡: [],
                        å¹´: d.å¹´,
                        æœˆæ•°å€¤: d.æœˆæ•°å€¤,
                        æœˆ: d.æœˆ,
                        å¹´æœˆ: d.å¹´æœˆ,
                        isæ£šå¸æœˆ: d.æœˆæ•°å€¤ === 3 || d.æœˆæ•°å€¤ === 10
                    };
                }
                monthlyData[key].åœ¨åº« += d.æœˆæœ«åœ¨åº«;
                monthlyData[key].å‡ºåº« += d.å½“æœˆå‡ºåº«;
                monthlyData[key].å›è»¢ç‡.push(d.åœ¨åº«å›è»¢ç‡);
                // é€šå¸¸æœˆã®ã¿
                if (d.æœˆæ•°å€¤ !== 3 && d.æœˆæ•°å€¤ !== 10 && d.åœ¨åº«å›è»¢ç‡ <= 100) {
                    monthlyData[key].é€šå¸¸æœˆå›è»¢ç‡.push(d.åœ¨åº«å›è»¢ç‡);
                }
            });

            const sortedData = sortMonthsFiscalYear(Object.values(monthlyData));
            const years = [...new Set(sortedData.map(d => d.æœˆæ•°å€¤ >= 4 ? d.å¹´ : d.å¹´ - 1))];
            const useYearMonth = years.length > 1 || selectedYear === 'all';
            const labels = sortedData.map(d => useYearMonth ? d.å¹´æœˆ : d.æœˆ);
            const inventoryData = sortedData.map(d => d.åœ¨åº«);
            const shipmentData = sortedData.map(d => d.å‡ºåº«);
            const turnoverData = sortedData.map(d =>
                d.å›è»¢ç‡.reduce((a,b) => a+b, 0) / d.å›è»¢ç‡.length
            );
            const normalTurnoverData = sortedData.map(d => {
                if (d.é€šå¸¸æœˆå›è»¢ç‡.length > 0) {
                    return d.é€šå¸¸æœˆå›è»¢ç‡.reduce((a,b) => a+b, 0) / d.é€šå¸¸æœˆå›è»¢ç‡.length;
                }
                return null;
            });

            // åœ¨åº«æ¨ç§»ã‚°ãƒ©ãƒ•
            if (charts.inventory) charts.inventory.destroy();
            charts.inventory = new Chart(document.getElementById('inventoryChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æœˆæœ«åœ¨åº«',
                        data: inventoryData,
                        backgroundColor: 'rgba(102, 126, 234, 0.7)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }, {
                        label: 'å½“æœˆå‡ºåº«',
                        data: shipmentData,
                        backgroundColor: 'rgba(118, 75, 162, 0.7)',
                        borderColor: 'rgba(118, 75, 162, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            // å›è»¢ç‡ã‚°ãƒ©ãƒ•
            if (charts.turnover) charts.turnover.destroy();
            charts.turnover = new Chart(document.getElementById('turnoverChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å…¨ä½“å¹³å‡å›è»¢ç‡',
                        data: turnoverData,
                        borderColor: 'rgba(149, 165, 166, 0.8)',
                        backgroundColor: 'rgba(149, 165, 166, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2,
                        pointRadius: 4,
                        pointBackgroundColor: 'rgba(149, 165, 166, 1)',
                        pointHoverRadius: 6
                    }, {
                        label: 'é€šå¸¸æœˆå¹³å‡å›è»¢ç‡',
                        data: normalTurnoverData,
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3,
                        pointRadius: 6,
                        pointBackgroundColor: 'rgba(102, 126, 234, 1)',
                        pointHoverRadius: 8,
                        spanGaps: true
                    }, {
                        label: 'æœ€å„ªç§€ãƒ©ã‚¤ãƒ³ï¼ˆ30å›ï¼‰',
                        data: Array(labels.length).fill(30),
                        borderColor: 'rgba(39, 174, 96, 0.6)',
                        borderWidth: 2,
                        borderDash: [10, 5],
                        fill: false,
                        pointRadius: 0
                    }, {
                        label: 'å„ªç§€ãƒ©ã‚¤ãƒ³ï¼ˆ20å›ï¼‰',
                        data: Array(labels.length).fill(20),
                        borderColor: 'rgba(243, 156, 18, 0.6)',
                        borderWidth: 2,
                        borderDash: [10, 5],
                        fill: false,
                        pointRadius: 0
                    }, {
                        label: 'æ¨™æº–ãƒ©ã‚¤ãƒ³ï¼ˆ15å›ï¼‰',
                        data: Array(labels.length).fill(15),
                        borderColor: 'rgba(231, 76, 60, 0.6)',
                        borderWidth: 2,
                        borderDash: [10, 5],
                        fill: false,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.parsed.y === null) return '';
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(1);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1);
                                }
                            }
                        }
                    }
                }
            });
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°ï¼ˆå–¶æ¥­æ‰€åˆ¥ç·åˆè©•ä¾¡ï¼‰
        function updateTable(data) {
            // å–¶æ¥­æ‰€ã”ã¨ã«é›†è¨ˆ
            const officeStats = {};
            data.forEach(d => {
                if (!officeStats[d.å–¶æ¥­æ‰€]) {
                    officeStats[d.å–¶æ¥­æ‰€] = {
                        å–¶æ¥­æ‰€: d.å–¶æ¥­æ‰€,
                        éƒ¨é–€: d.éƒ¨é–€,
                        å…¨ãƒ‡ãƒ¼ã‚¿: [],
                        é€šå¸¸æœˆãƒ‡ãƒ¼ã‚¿: []
                    };
                }
                officeStats[d.å–¶æ¥­æ‰€].å…¨ãƒ‡ãƒ¼ã‚¿.push(d.åœ¨åº«å›è»¢ç‡);
                // é€šå¸¸æœˆã®ã¿
                if (d.æœˆæ•°å€¤ !== 3 && d.æœˆæ•°å€¤ !== 10 && d.åœ¨åº«å›è»¢ç‡ <= 100) {
                    officeStats[d.å–¶æ¥­æ‰€].é€šå¸¸æœˆãƒ‡ãƒ¼ã‚¿.push(d.åœ¨åº«å›è»¢ç‡);
                }
            });

            // çµ±è¨ˆè¨ˆç®—
            const officeList = Object.values(officeStats).map(stat => {
                const normalAvg = stat.é€šå¸¸æœˆãƒ‡ãƒ¼ã‚¿.reduce((a,b) => a+b, 0) / stat.é€šå¸¸æœˆãƒ‡ãƒ¼ã‚¿.length;
                const allAvg = stat.å…¨ãƒ‡ãƒ¼ã‚¿.reduce((a,b) => a+b, 0) / stat.å…¨ãƒ‡ãƒ¼ã‚¿.length;
                
                // æ¨™æº–åå·®è¨ˆç®—
                const mean = normalAvg;
                const variance = stat.é€šå¸¸æœˆãƒ‡ãƒ¼ã‚¿.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / stat.é€šå¸¸æœˆãƒ‡ãƒ¼ã‚¿.length;
                const stdDev = Math.sqrt(variance);
                
                return {
                    ...stat,
                    é€šå¸¸æœˆå¹³å‡: normalAvg,
                    å…¨æœŸé–“å¹³å‡: allAvg,
                    æ¨™æº–åå·®: stdDev
                };
            }).sort((a, b) => b.é€šå¸¸æœˆå¹³å‡ - a.é€šå¸¸æœˆå¹³å‡);

            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = officeList.map((stat, i) => {
                let rowClass = '';
                let statusEmoji = '';
                let statusText = '';
                let badge = '';
                const cashDays = calculateCashDays(stat.é€šå¸¸æœˆå¹³å‡);

                if (stat.é€šå¸¸æœˆå¹³å‡ >= 30) {
                    rowClass = 'row-excellent';
                    statusEmoji = 'ğŸŸ¢';
                    statusText = 'æœ€å„ªç§€';
                    if (i === 0) badge = '<span class="badge badge-top">ğŸ† TOP</span>';
                } else if (stat.é€šå¸¸æœˆå¹³å‡ >= 20) {
                    rowClass = 'row-good';
                    statusEmoji = 'ğŸŸ¡';
                    statusText = 'å„ªç§€';
                } else if (stat.é€šå¸¸æœˆå¹³å‡ >= 15) {
                    rowClass = 'row-warning';
                    statusEmoji = 'ğŸŸ ';
                    statusText = 'æ¨™æº–';
                } else {
                    rowClass = 'row-danger';
                    statusEmoji = 'ğŸ”´';
                    statusText = 'è¦æ”¹å–„';
                }

                // å®‰å®šæ€§è©•ä¾¡
                if (stat.æ¨™æº–åå·® < 5) {
                    badge += '<span class="badge badge-stable">ğŸ“Š å®‰å®š</span>';
                } else if (stat.æ¨™æº–åå·® > 15) {
                    badge += '<span class="badge badge-warning">âš ï¸ å¤‰å‹•å¤§</span>';
                }

                return `
                    <tr class="${rowClass}">
                        <td><strong>${i + 1}</strong></td>
                        <td><strong>${stat.å–¶æ¥­æ‰€}</strong>${badge}</td>
                        <td>${stat.éƒ¨é–€}</td>
                        <td class="number"><strong>${stat.é€šå¸¸æœˆå¹³å‡.toFixed(1)}</strong></td>
                        <td class="number">${stat.å…¨æœŸé–“å¹³å‡.toFixed(1)}</td>
                        <td class="number">${stat.æ¨™æº–åå·®.toFixed(1)}</td>
                        <td class="number">${cashDays.toFixed(1)}æ—¥</td>
                        <td>${statusEmoji} ${statusText}</td>
                    </tr>
                `;
            }).join('');
        }

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°
        function updateDashboard() {
            const data = getFilteredData();
            if (data.length === 0) {
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').innerHTML =
                    '<strong>ãƒ‡ãƒ¼ã‚¿ãªã—:</strong> é¸æŠã—ãŸæ¡ä»¶ã«è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
                return;
            }
            document.getElementById('error').style.display = 'none';
            updateKPIs(data);
            updateCharts(data);
            updateTable(data);
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
        window.addEventListener('load', loadData);
    </script>
</body>
</html>